# OpenStack企业私有云实践

理解OpenStack架构和各个服务的功能、组件、运行原理才是最重要的。

## OpenStack介绍
### OpenStack版本历史

OpenStack是一个开源的云计算管理平台项目，由几个主要的组件组合起来完成具体工作。支持几乎所有类型的云环境，项目目标是提供实施简单、可大规模扩展、丰富、标准统一的云计算管理平台。OpenStack通过各种互补的服务提供了基础设施即服务（IaaS）的解决方案，每个服务提供API以进行集成。

OpenStack最早包含两个模块：Nova和Swift,这两个是可选的两个组件。发展迅速主要是因为有非常多的场商加入。

它的版本是用地名来命名的，街道的名字来命名的，现在是L版。真正稳定是G版，I版是最后一个支持centos6和python2.6的版本，后面就是python2.7的版本了。

[官网](docs.openstack.org)


OpenStack项目主要管理了三大资源：计算、网络、存储资源。

计算：OpenStack可以管理大量的云主机，可以按需使用资源，可以弹性地进行扩张

存储资源：可以管理硬盘。

网络：真正使用很少用SDN,


### OpenStack组件及功能：

Horizon:基于OpenStack API接口使用django开发的web管理

Nova: 通过虚拟化技术提供计算资源池

Neutron: 实现了虚拟机的网络资源管理

#### Storage(存储)

Object Storage(Swift): 对象存储，适用于“一次写入、多次读取”

Block Storage(Cinder): 块存储，提供存储资源池

#### Shared Services（共享服务）

Identify Service(Keystone): 认证管理

Image Service(Glance)： 提供虚拟镜像的注册和存储管理

Telemetry(Ceilometer): 提供监控和数据采集、计量服务 

#### Higher-level servceis(高层服务)

Orchestration(Heat): 自动化部署的组件

Database Service(Trove)： 提供数据库应用服务

主要使用python来开发


## OpenStack基础环境


两台虚拟机：
linux-node1.example.com   192.168.56.11   控制节点
linux-node2.example.com   192.168.56.12   计算节点

#### 时间同步

	yum install chrony -y
	sed -i '22aallow 192.168/16' /etc/chrony.conf
	systemctl enable chronyd.service
	systemctl start chronyd.service
	timedatectl set-timezone Asia/Shanghai
	
#### Base
<pre>
yum install -y http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-5.noarch.rpm
yum install centos-release-openstack-liberty -y
yum install python-openstackclient -y
</pre>
**制作keystone源**
<pre>
echo "[keystone]
name=keystone
baseurl=http://mirrors.aliyun.com/centos/7.2.1511/cloud/x86_64/openstack-liberty/
enabled=1
gpgcheck=0" > /etc/yum.repos.d/keystone.repo
</pre>

#### MySQL

	yum install mariadb mariadb-server MySQL-python -y
	/bin/cp /usr/share/mysql/my-medium.cnf /etc/my.cnf
	vim /etc/my.cnf	
	[mysqld]
	default-storage-engine = innodb
	innodb_file_per_table
	collation-server = utf8_general_ci
	init-connect = 'SET NAMES utf8'
	character-set-server = utf8
	systemctl enable mariadb.service
	systemctl start mariadb.service
	mysql_secure_installation
	## 设置密码为123456

##### SQL语句

<pre>
CREATE DATABASE keystone;
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'keystone';
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'keystone';

CREATE DATABASE glance;
GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'glance';
GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'glance';

CREATE DATABASE nova;
GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' IDENTIFIED BY 'nova';
GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' IDENTIFIED BY 'nova';

CREATE DATABASE neutron;
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY 'neutron';
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'neutron';

CREATE DATABASE cinder;
GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'localhost' IDENTIFIED BY 'cinder';
GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'%' IDENTIFIED BY 'cinder';
show databases;
quit
</pre>

#### 消息队列RabbitMQ

SOA  两个角色，服务的提供者，服务的消费者 松耦合

<pre>
yum install rabbitmq-server -y
systemctl enable rabbitmq-server.service
systemctl start rabbitmq-server.service
netstat -lntup|grep 5672
</pre>

给rabbitmq新建一个用户并授权 

<pre>
rabbitmqctl add_user openstack openstack
rabbitmqctl set_permissions openstack ".*" ".*" ".*"
### 这里是所有vhost的所有权限
</pre>

rabbitmq默认有很多插件，其中有一个是WEB的插件，可以通过WEB界面来查看rabbitmq的状态

#### 启动rabbitmq的web插件
<pre>
rabbitmq-plugins list
rabbitmq-plugins enable rabbitmq_management
systemctl restart rabbitmq-server.service
## 默认用户名密码：guest/guest,这时前面授权的openstack还不能用；默认是有TAGS是administrator的用户才可以登录，所以需要在Admin里面更新openstack用户的tags。
</pre>

#### rabbitmq的重要性

它是整个openstack架构里面扮演的是交通枢纽的角色，并且它是支持集群的。

#### rabbitmq监控

通过页面的最下角的HTTP API就可以进行监控；可以监控哪个队列有没有被堵。

### Keystone

#### 安装
<pre>
yum install -y openstack-keystone httpd mod_wsgi memcached python-memcached
</pre>
> 在用户名密码通过keystone认证后会产生一个tocken,以前这个tocken都是记录在一个表里面的，时间长了的话这个表就会很大；在新的版本中，用memcache来实现这个存储功能。

#### 配置

上传配置文件到/opt下
<pre>
unzip config.zip
</pre>
修改相关配置文件
<pre>
/etc/keystone/keystone.conf
[DEFAULT]
admin_token  ## 使用token连接到keystone
[database]
connection = mysql://keystone:keystone@192.168.56.11/keystone
[memcache]
servers = 192.168.56.11:11211
[token]
provider = uuid
driver = memcache
[revoke]
driver = sql
</pre>
所有配置
<pre>
[root@linux-node1 yum.repos.d]# grep '^[a-Z]' /etc/keystone/keystone.conf 
admin_token = 863d35676a5632e846d9
connection = mysql://keystone:keystone@192.168.56.11/keystone
servers = 192.168.56.11:11211
driver = sql
provider = uuid
driver = memcache
</pre>
> 还有一行是关于 `debug` 的配置 `verbose = true`
做一个随机码来当做token
<pre>
openssl rand -hex 10
</pre>

#### 同步及启动

##### 创建keystone数据库表
<pre>
su -s /bin/sh -c "keystone-manage db_sync" keystone
# 执行完后就会在/var/log/keystone下面生成日志，可以发现日志是属于keystone用户的
# db_sync             Sync the database.
</pre>

##### 启动keystone

以前启动是通过自己的一个python的服务，但是性能不好；后来使用APACHE来启动
###### 启动memcached
<pre>
systemctl enable memcached.service
systemctl start memecached.service
</pre>
###### 启动Apache

<pre>
cat /etc/httpd/conf.d/wsgi-keystone.conf
Listen 5000
Listen 35357

<VirtualHost *:5000>
    WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}
    WSGIProcessGroup keystone-public
    WSGIScriptAlias / /usr/bin/keystone-wsgi-public
    WSGIApplicationGroup %{GLOBAL}
    WSGIPassAuthorization On
    <IfVersion >= 2.4>
      ErrorLogFormat "%{cu}t %M"
    </IfVersion>
    ErrorLog /var/log/httpd/keystone-error.log
    CustomLog /var/log/httpd/keystone-access.log combined

    <Directory /usr/bin>
        <IfVersion >= 2.4>
            Require all granted
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
</VirtualHost>

<VirtualHost *:35357>
    WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}
    WSGIProcessGroup keystone-admin
    WSGIScriptAlias / /usr/bin/keystone-wsgi-admin
    WSGIApplicationGroup %{GLOBAL}
    WSGIPassAuthorization On
    <IfVersion >= 2.4>
      ErrorLogFormat "%{cu}t %M"
    </IfVersion>
    ErrorLog /var/log/httpd/keystone-error.log
    CustomLog /var/log/httpd/keystone-access.log combined

    <Directory /usr/bin>
        <IfVersion >= 2.4>
            Require all granted
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
</VirtualHost>
</pre>
> 这里开了两个虚拟主机，一个是5000端口，是给正常的API来访问的，35357是给管理的API使用的。

修改/etc/httpd/conf/httpd.conf配置 `servername`

<pre>
ServerName 192.168.56.11:80
</pre>
启动
<pre>
systemctl enable httpd.service
systemctl start httpd.service
</pre>

#### 权限管理

设置两个环境变量 

<pre>
export OS_TOKEN=863d35676a5632e846d9
export OS_URL=http://192.168.56.11:35357/v3
export OS_IDENTITY_API_VERSION=3
</pre>

这时就可以连上keystone了，在新版本中，连接keystone的时候命令都改成了openstack

##### openstack命令使用
* 查看keystone有哪些用户 
<pre>
openstack user list
</pre>
* 创建一个租户
<pre>
openstack project create --domain default   --description "Admin Project" admin
</pre>
* 创建admin用户
<pre>
openstack user create --domain default --password-prompt admin
</pre>
> 这里设置密码为admin,但是在生产中一定要复杂，它后面是可以登录到dashboard上面的。


* 创建admin角色

<pre>
openstack role create admin
</pre>
* 关联admin用户、admin项目（租户）和admin角色
<pre>
openstack role add --project admin --user admin admin
</pre>

* 创建demo的项目，作为普通用户，后面通过这个用户来执行一些操作

<pre>
openstack project create --domain default --description "Demo Project" demo
openstack user create --domain default --password=demo demo
openstack role create user
openstack role add --project demo --user demo user
openstack project create --domain default --description "Service Project" service
</pre>
> 这里的Service Project是为了把以后的nova等服务加进去。

* 查看创建结果

<pre>
[root@linux-node1 ~]# openstack user list
+----------------------------------+-------+
| ID                               | Name  |
+----------------------------------+-------+
| 3e59d7ff78ae4b53a28c4c66456c0e73 | demo  |
| beaa5b94925845868e67bb7de63e0ea2 | admin |
+----------------------------------+-------+
[root@linux-node1 ~]# openstack role list
+----------------------------------+-------+
| ID                               | Name  |
+----------------------------------+-------+
| 3d1031b90b3e45718e12fcb4675db62d | user  |
| 8f79ee46270d4e2ebbac38d3c0751f94 | admin |
+----------------------------------+-------+
[root@linux-node1 ~]# openstack --help|grep list^C
[root@linux-node1 ~]# openstack project list
+----------------------------------+---------+
| ID                               | Name    |
+----------------------------------+---------+
| 9bc39520b1e44036988f286d95975639 | admin   |
| e77a70dde9e442469a82021b19cf0d75 | service |
| ec5d6ae9a57841ef97d22715cc52ed6d | demo    |
+----------------------------------+---------+
</pre>
> 只有admin和user两个角色 ，它不是随便配置的

#### 服务目录及注册服务 

* 注册keystone
<pre>
openstack service create --name keystone --description "OpenStack Identity" identity
</pre>
* 注册keystone的endpoint
<pre>
openstack endpoint create --region RegionOne identity public http://192.168.56.11:5000/v2.0
openstack endpoint create --region RegionOne identity internal http://192.168.56.11:5000/v2.0
openstack endpoint create --region RegionOne identity admin http://192.168.56.11:35357/v2.0
</pre>
* 删除endpoint节点

<pre>
openstack endpoint delete id
</pre>
endpoint有三种类型

1. 公共的（放在互联网上，对公众可见）
2. 内部的
3. 管理的

> 区分这三种API是为了更加灵活地调用各种API。

#### 测试

因为前面使用了admin_token的方式，但现在我们已经有了用户名密码了，所以先把前面的环境变量去掉，然后用我们的用户名和密码来进行验证。

<pre>
unset OS_TOKEN
unset OS_URL
</pre>
##### 使用参数方式获取token

<pre>
openstack --os-auth-url http://192.168.56.11:35357/v3 \
--os-project-domain-id default --os-user-domain-id default \
--os-project-name admin --os-username admin --os-auth-type password \
token issue
</pre>

> 这里返回结果才说明keystone成功

配置环境变量来代替上面这一段长长的命令

<pre>
[root@linux-node1 ~]# vim admin-openrc.sh
export OS_PROJECT_DOMAIN_ID=default
export OS_USER_DOMAIN_ID=default
export OS_PROJECT_NAME=admin
export OS_TENANT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=admin
export OS_AUTH_URL=http://192.168.56.11:35357/v3
export OS_IDENTITY_API_VERSION=3
</pre>












### 控制节点

	echo "linux-node2.example.com" > /etc/hostname
	cat >> /etc/hosts <<EOF
	192.168.56.11	linux-node1.example.com
	192.168.56.12	linux-node2.example.com
	EOF
#### 时间同步

### 计算节点

	echo "linux-node1.example.com" > /etc/hostname
	cat >> /etc/hosts <<EOF
	192.168.56.11	linux-node1.example.com
	192.168.56.12	linux-node2.example.com
	EOF


## 服务学习

### keystone

keystone是一个验证服务，它主要有两个作用，一个是用户认证，另外一个是服务目录

* 用户与认证：用户权限与用户行为跟踪
* 服务目录：提供一个服务目录，包括所有服务项与相关API的端点

> 在安装的时候所有的服务都需要在keystone上做服务的注册。这样别的服务才能调用。

#### 相关名词说明

##### 用户认证相关
User: 用户

Tenant: 租户（项目），它是一个可以访问资源的组合。

Token: 令牌

Role: 角色（代表一个权限的组合）

##### 服务目录相关
Service: 服务

Endpoint: 端点（连接方式）


###

# 端口统计

服务 |  端口
----|---|
rabbitmq|   5672
rabbitmq-web|15672
keystone-admin|35357
keystone-general|5000


















# JIRA和CONFLUENCE使用

scrum 把所有的事分小了去做

最短的时间内交付最多的价值

整个团队里面三个角色，一般七个成员左右，

Product Owner       Scrum Team        Scrum Master

########## Artifacts

produc Backlog    需求列表

epic  形容大的需求点，

theam

user story

从大到小的需求点

Sprint Backlog   当前迭代要做的东西 ，迭代完了后就是Increments

Daily scrum

Sprint Review   看准上线版本

Sprint Restrospective   团队内部交流

## JIRA使用

* 项目计划
* 项目执行
* 项目跟踪



### 项目计划（）

创建项目－－项目设置              录入需求、创建任务     创建子任务  （这两个就是issue）
Jira Admin   Project Manager   Project Manager(product Manager/Engineer/Designer)

### 项目执行

### 项目跟踪

把大事拆成小事，每个小事做好才能做好大事

